<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>

   


<head>
<link rel="stylesheet" type="text/css" href="bootstrap.css">
<script type="text/javascript" src="jquery.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="bootstrap.js"></script>
</head>
<body>

<div class="navbar">
    <div class="navbar-inner">
      <a class="brand">Promoter Architecture Browser</a>
      <ul class="nav">
        <li>
          <a href="architectures.html" >Size 3</a>
        </li>
        <li>
          <a href="architectures_4.html">Size 4</a>
        </li>
        <li class="active">
          <a href="architectures_5.html">Size 5</a>
        </li>
      </ul> 
    </div>
</div>

<script>

function drawGenes(divName, config, leftBuffer, promoter, position){
          // window.alert("drawing: "+divName+" with "+config.length);
           var w=300;
           var h=70;
           var topBuffer=10;
           var bins=[0, 0];
           var levels=6;
           //d3.select(divName).selectAll("svg").remove();

           var svg = d3.select("#"+divName).append("svg")
              .attr("width", w+leftBuffer)
              .attr("height", h);

           var arr=new Array;
           arr[0]=1;
               
            var xScale = d3.scale.linear()
                     .domain([d3.min(config, function(d){ return d.start; }), d3.max(config, function(d){ return d.end; })])
                     .range([0, w]);
            var rects = svg.selectAll("rect")
              .data(config)
              .enter()
              .append("rect")
              .attr("x", function(d, i){
                return leftBuffer+xScale(d.start);
              })
              .attr("y", function(d, i){
                if(i==0){
                  bins[0]=d.end;
                  return 5+topBuffer;
                }
                for(var j = 0; j<bins.length; j++){
                  if(bins[j]<d.start){
                    bins[j]=d.end;
                    return (h/levels*j)+(5*(1+j))+topBuffer;
                  }
                }
                bins[bins.length]=d.end;
                return (h/levels*(bins.length-1))+(5*(bins.length))+topBuffer;
              })
              .attr("width", function(d, i){
                return xScale(d.end)-xScale(d.start);
              })
              .attr("height", function(d, i){
                return h/levels;
              })
              .attr("fill", function(d, i){
                return "darkblue";
              });

              var bins=[0, 0];
              svg.selectAll("text").data(config)
                                   .enter()
                                   .append("svg:text")
                                   .attr("x", function(d, i){
                return xScale(d.start)+5+leftBuffer;
              })
              .attr("y", function(d, i){
                if(i==0){
                  bins[0]=d.end;
                  return 3+h/levels+topBuffer;
                }
                for(var j = 0; j<bins.length; j++){
                  if(bins[j]<d.start){
                    bins[j]=d.end;
                    return (h/levels*j)+(5*(1+j))+h/levels-2+topBuffer;
                  }
                }
                bins[bins.length]=d.end;
                return (h/levels*(bins.length-1))+(5*(bins.length))+h/levels-2+topBuffer;
              })
              .text(function(datum) {return datum.name;})
              .attr("fill", "white")
              .attr("font-size", 9);


              svg.append("text").attr("x", 2).attr("y", 10).text(promoter+" at position "+position).attr("fill", "black").attr("font-size", 12);


             }

var width = 600,
    height = 600;

var center_x=width/2.0;
var canter_y=height/2.0;

var bb_switch=[0, 1];
var bb_cluster=[Math.sqrt(3)/2.0, -0.5];
var bb_barrier=[-Math.sqrt(3)/2.0, -0.5];

$.getJSON("networkjson_middle2_5", function(data){



var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var str=60;



var parents = {};
data.forEach( function(d) { 

  if(! (d.parent in parents) ){
     parents[d.parent] = [];
  }
  parents[d.parent].push(d);
});


cols=["#fff999", "#ff9999", "#ff99ff", "#99ccff", "#66cc99", "#ccff66"];



var color = d3.scale.ordinal().range(["#787878", "#909090", "#a8a8a8", "#c0c0c0", "#d8d8d8","#e8e8e8"]);
  //    .range(["#fff999", "#ff9999", "#ff99ff", "#99ccff", "#66cc99", "#ccff66"]);
//    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

//["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]


var pie = d3.layout.pie()
    .sort(null)
    .value(function(d_1) { return d_1.count; });


Object.keys(parents).forEach(function(d){

     //radius
     sum=0;
     parents[d].forEach( function(i){ sum=sum+i.count; })

     if(sum>2){
     radius= 8*Math.sqrt(sum); 

    arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(0);
 
     //cx
     par=parseInt(d);
     bar=par%10;
     swi=(par%100-bar)/10;
     clu=(par%1000-bar-swi*10)/100;                                                  
     cx=center_x+str*bb_barrier[0]*bar+str*bb_cluster[0]*clu;

     //cy
     par=parseInt(d);
     cy=center_x+str*bb_switch[1]*swi+str*bb_barrier[1]*bar+str*bb_cluster[1]*clu;

     //draw pie chart

     parents[d].forEach(function(d_1) {
         d_1.count = +d_1.count;
     });

  var g = svg.selectAll(".arc"+d)
      .data(pie(parents[d]))
      .enter().append("g")
      .attr("class", "arc")
      .attr("transform", "translate(" + cx + "," + cy + ")").on("click", function(d_1,i) {
           // window.alert("click found");
            $.getJSON("ecoli_promoters_5", function(promoter_data){
               // window.alert("promoters found");
                promoters=promoter_data[parents[d][i].id];
                //window.alert("id is "+parents[d][i].id+" which has "+promoters.length);
                d3.select("#labels").selectAll("div").remove();
                geneSVGs=d3.select("#labels").selectAll("div").data(promoters).enter().append("div")
                .attr("name", function(d){ return d.promoter+"_at_"+d.config[0].start; })
                .attr("id", function(d){ return d.promoter+"_at_"+d.config[0].start; });

                

              promoters.forEach(function(p){
               // window.alert(p);
                
                drawGenes(p.promoter+"_at_"+p.config[0].start, p.config, 20, p.promoter, p.config[0].start);
                
              }); 


   
            });
      });

  g.append("path")
      .attr("d", arc)
      .style("fill", function(d_1, i) { return color(i); }).on("click", function(d_1,i) {
           // window.alert("click found");
            $.getJSON("ecoli_promoters_5", function(promoter_data){
               // window.alert("promoters found");
                promoters=promoter_data[parents[d][i].id];
                //window.alert("id is "+parents[d][i].id+" which has "+promoters.length);
                d3.select("#labels").selectAll("div").remove();
                geneSVGs=d3.select("#labels").selectAll("div").data(promoters).enter().append("div")
                .attr("name", function(d){ return d.promoter+"_at_"+d.config[0].start; })
                .attr("id", function(d){ return d.promoter+"_at_"+d.config[0].start; });

                

              promoters.forEach(function(p){
               // window.alert(p);
                
                drawGenes(p.promoter+"_at_"+p.config[0].start, p.config, 20, p.promoter, p.config[0].start);
                
              }); 


   
            });
      });

  g.append("text")
      .attr("transform", function(d_1, i) { 
        if(parents[d][i].id=="1111"){
          return "translate(-1, 2)";
        }
        if(parents[d][i].id=="3333"){
          return "translate(-1, 2)";
        }
        if(parents[d][i].id=="2222"){
          return "translate(-1, 2)";
        }
        return "translate(" + arc.centroid(d_1) + ")"; })
      .attr("font-size", 12)
      .style("text-anchor", "middle")
      .on("click", function(d_1,i) {
           // window.alert("click found");
            $.getJSON("ecoli_promoters_5", function(promoter_data){
               // window.alert("promoters found");
                promoters=promoter_data[parents[d][i].id];
                //window.alert("id is "+parents[d][i].id+" which has "+promoters.length);
                d3.select("#labels").selectAll("div").remove();
                geneSVGs=d3.select("#labels").selectAll("div").data(promoters).enter().append("div")
                .attr("name", function(d){ return d.promoter+"_at_"+d.config[0].start; })
                .attr("id", function(d){ return d.promoter+"_at_"+d.config[0].start; });

                

              promoters.forEach(function(p){
               // window.alert(p);
                
                drawGenes(p.promoter+"_at_"+p.config[0].start, p.config, 20, p.promoter, p.config[0].start);
                
              }); 


   
            });
      })
      .text(function(d_1, i) { 
        
        return ""+parents[d][i].count; });

   }
   
  });
});


</script>